<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Optimizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; }
        
        /* Sidebar Control Panel */
        .sidebar { width: 400px; background: white; border-right: 1px solid #e2e8f0; padding: 25px; display: flex; flex-direction: column; overflow-y: auto; }
        .input-group { margin-bottom: 20px; }
        label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; margin-top: 8px; font-family: inherit; resize: none; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #1e293b; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Resume Preview Area */
        .preview { flex-grow: 1; padding: 40px; overflow-y: auto; display: flex; justify-content: center; }
        #resume-paper { 
            background: white; width: 210mm; min-height: 297mm; padding: 20mm; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); color: #1e293b; 
        }

        /* Resume Typography */
        .res-name { font-size: 28px; font-weight: 800; margin: 0; color: #000; text-transform: uppercase; }
        .res-contact { font-size: 13px; color: #64748b; margin-top: 5px; }
        .res-section-header { font-weight: 700; color: var(--accent); border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; margin: 25px 0 10px 0; font-size: 13px; text-transform: uppercase; }
        .job-title { font-weight: 700; display: block; }
        .job-meta { font-size: 12px; color: #64748b; margin-bottom: 8px; display: block; }
        ul { padding-left: 18px; margin: 0; }
        li { margin-bottom: 6px; font-size: 14px; }

        @media print { .sidebar { display: none; } .preview { padding: 0; background: white; } #resume-paper { box-shadow: none; width: 100%; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>Resume Optimizer</h2>
        
        <div class="input-group">
            <label>Step 1: Upload your current Resume</label>
            <input type="file" id="resume-upload" accept=".pdf,.txt" style="margin-top:10px; font-size: 12px;">
        </div>

        <div class="input-group">
            <label>Step 2: Paste Target Job Description</label>
            <textarea id="job-desc" placeholder="Paste the job you want here..."></textarea>
        </div>

        <button id="opt-btn" class="btn btn-primary" onclick="optimizeResume()">âœ¨ Tailor My Details</button>
        <button class="btn btn-outline" onclick="window.print()">ðŸ“¥ Save as PDF</button>
        
        <p id="status" style="font-size: 12px; color: var(--accent); margin-top: 15px; text-align: center;"></p>
    </div>

    <div class="preview">
        <div id="resume-paper">
            <div id="res-header">
                <div id="res-name" class="res-name" contenteditable="true">YOUR NAME</div>
                <div id="res-contact" class="res-contact" contenteditable="true">Email | Phone | Location</div>
            </div>

            <div class="res-section-header">Professional Objective</div>
            <div id="res-objective" style="font-size: 14px;" contenteditable="true">Upload your resume to see your tailored objective here.</div>

            <div class="res-section-header">Professional Experience</div>
            <div id="experience-container">
                <div style="font-size: 14px; color: #94a3b8;">Your experience will be reformatted here...</div>
            </div>

            <div class="res-section-header">Technical Skills</div>
            <div id="res-skills" style="font-size: 14px;" contenteditable="true">Skills list...</div>

            <div class="res-section-header">Education</div>
            <div id="res-education" style="font-size: 14px;" contenteditable="true">Education details...</div>
        </div>
    </div>

    <script>
       const FUNC_URL = 'https://iriwdybkpvahsputenzc.supabase.co/functions/v1/openai-proxy';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlyaXdkeWJrcHZhaHNwdXRlbnpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MjE1MzIsImV4cCI6MjA4NDQ5NzUzMn0.ohEgOTIjzSu4oB_x8XNvGSWWcE22yyW04E7Duk-7LJ8';
        let rawResumeText = "";

        // File reader logic (PDF.js)
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        document.getElementById('resume-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('status').innerText = "Processing file...";
            
            if (file.type === "application/pdf") {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let text = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(s => s.str).join(" ") + " ";
                }
                rawResumeText = text;
            } else {
                rawResumeText = await file.text();
            }
            document.getElementById('status').innerText = "Resume ready!";
        });

        async function optimizeResume() {
            const jd = document.getElementById('job-desc').value;
            if (!jd || !rawResumeText) return alert("Upload resume and paste JD first!");

            const btn = document.getElementById('opt-btn');
            btn.disabled = true;
            document.getElementById('status').innerText = "AI is rewriting your resume...";

            try {
                const res = await fetch(FUNC_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}`, 'apikey': ANON_KEY },
                    body: JSON.stringify({ job_description: jd, current_resume: rawResumeText })
                });

                const data = await res.json();

                // UPDATE UI
                document.getElementById('res-name').innerText = data.name;
                document.getElementById('res-contact').innerText = data.contact;
                document.getElementById('res-objective').innerText = data.objective;
                document.getElementById('res-skills').innerText = data.skills;
                document.getElementById('res-education').innerText = data.education;

                const expContainer = document.getElementById('experience-container');
                expContainer.innerHTML = "";
                data.experience.forEach(job => {
                    const jobHtml = `
                        <div style="margin-bottom: 15px;">
                            <span class="job-title" contenteditable="true">${job.role}</span>
                            <span class="job-meta" contenteditable="true">${job.company}</span>
                            <ul>${job.bullets.map(b => `<li contenteditable="true">${b}</li>`).join('')}</ul>
                        </div>`;
                    expContainer.insertAdjacentHTML('beforeend', jobHtml);
                });

                document.getElementById('status').innerText = "Done!";
            } catch (err) {
                document.getElementById('status').innerText = "Error!";
                console.error(err);
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
