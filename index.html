<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Master | Enhanced Test</title>
    <style>
        :root { 
            --primary: #4f46e5; 
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b;
            --bg: #f8fafc; 
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg); 
            padding: 0;
            margin: 0;
            line-height: 1.6;
        }
        .app-container { 
            max-width: 1000px; 
            margin: 0 auto;
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            overflow: hidden; 
            min-height: 100vh;
        }
        
        /* Navigation Tabs */
        .tabs { 
            display: flex; 
            background: #1e293b; 
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .tab-btn { 
            flex: 1; 
            padding: 18px; 
            border: none; 
            background: none; 
            color: #94a3b8; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 1rem; 
            transition: 0.3s; 
        }
        .tab-btn.active { 
            color: white; 
            border-bottom: 4px solid var(--primary); 
            background: #334155; 
        }

        .content-section { 
            padding: 20px; 
            display: none; 
        }
        .content-section.active { 
            display: block; 
        }

        /* Test Mode Selector - FIXED */
        .test-mode-container {
            margin: 15px 0;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 10px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        .test-mode-label {
            font-weight: bold;
            color: #1e40af;
            white-space: nowrap;
        }
        #test-mode {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border-radius: 6px;
            border: 2px solid #cbd5e1;
            font-size: 14px;
            background: white;
        }
        #show-results-btn {
            padding: 10px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: none;
            white-space: nowrap;
        }

        /* Score Sticky Header - FIXED */
        .score-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 15px;
            border-bottom: 2px solid #e2e8f0;
            z-index: 99;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .score-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .score-display {
            font-size: 1.1rem;
            font-weight: bold;
        }
        .progress-container {
            flex: 1;
            min-width: 200px;
        }
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--primary), #6366f1);
            width: 0%;
            transition: width 0.5s ease;
        }
        .score-message {
            font-size: 0.9rem;
            color: #64748b;
            text-align: center;
            margin-top: 5px;
        }

        /* Question Container */
        .question-container {
            padding: 20px;
        }
        
        /* Question Card - FIXED */
        .question-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
        }
        .question-card.answered {
            border-color: var(--primary);
            background: #f8fafc;
        }
        
        .question-number {
            display: inline-block;
            background: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            font-weight: bold;
            margin-right: 10px;
            font-size: 0.9rem;
        }
        
        .question-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin: 15px 0;
            line-height: 1.5;
        }
        
        /* Options Grid - FIXED */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        @media (max-width: 768px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .option-btn {
            background: white;
            border: 2px solid #cbd5e1;
            padding: 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }
        .option-btn:hover:not(:disabled) {
            border-color: var(--primary);
            background: #f5f3ff;
            transform: translateY(-1px);
        }
        .option-btn.correct {
            background: #dcfce7 !important;
            border-color: var(--success) !important;
            color: #166534;
            font-weight: 600;
            position: relative;
        }
        .option-btn.correct::after {
            content: '‚úì';
            position: absolute;
            right: 10px;
            color: var(--success);
            font-weight: bold;
        }
        .option-btn.wrong {
            background: #fee2e2 !important;
            border-color: var(--danger) !important;
            color: #991b1b;
            text-decoration: line-through;
            position: relative;
        }
        .option-btn.wrong::after {
            content: '‚úó';
            position: absolute;
            right: 10px;
            color: var(--danger);
            font-weight: bold;
        }
        .option-btn.selected {
            background: #e0f2fe;
            border-color: #0ea5e9;
            font-weight: bold;
        }
        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        /* Explanation Box - FIXED */
        .explanation-box {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            display: none;
            animation: slideIn 0.3s ease;
        }
        .explanation-box.show {
            display: block;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .explanation-title {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Analysis Panel */
        .analysis-panel {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .analysis-panel.show {
            display: block;
        }
        
        .analysis-header {
            text-align: center;
            margin-bottom: 25px;
        }
        .analysis-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .rating-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
            margin: 10px 0;
        }
        .rating-excellent { background: #10b981; color: white; }
        .rating-good { background: #3b82f6; color: white; }
        .rating-average { background: #f59e0b; color: white; }
        .rating-needs-improvement { background: #ef4444; color: white; }
        
        .weak-areas {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .weak-area-item {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 4px solid var(--warning);
        }
        
        /* Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95rem;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: #4338ca;
        }
        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }
        .btn-secondary:hover {
            background: #cbd5e1;
        }
        
        /* Speaking Section (Minimal) */
        .speaking-container {
            padding: 20px;
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .content-section {
                padding: 15px;
            }
            .question-card {
                padding: 15px;
            }
            .option-btn {
                padding: 12px;
                font-size: 0.95rem;
            }
            .score-info {
                flex-direction: column;
                align-items: stretch;
            }
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('speaking')">üé§ Speaking</button>
        <button class="tab-btn" onclick="showTab('grammar')">üìù Grammar</button>
    </div>

    <!-- SPEAKING SECTION -->
    <div id="speaking" class="content-section active">
        <div class="speaking-container">
            <h2>Speaking Practice</h2>
            <p>Click the mic button to practice speaking English.</p>
            
            <div style="text-align: center; margin: 40px 0;">
                <button onclick="toggleMic()" id="mic-btn" 
                        style="padding: 20px 40px; font-size: 1.2rem; background: var(--primary); color: white; border: none; border-radius: 50px; cursor: pointer;">
                    üé§ Start Speaking
                </button>
                <p id="mic-status" style="margin-top: 10px; color: #64748b;">Status: Ready</p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                    <strong>Your Speech:</strong>
                    <p id="transcript-display" style="color: #1e293b; margin-top: 10px;">...</p>
                </div>
                <div style="background: #f8fafc; padding: 20px; border-radius: 10px;">
                    <strong>AI Feedback:</strong>
                    <div id="ai-feedback">Waiting for your speech...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- GRAMMAR SECTION - FIXED VERSION -->
    <div id="grammar" class="content-section">
        <!-- Test Mode Selector -->
        <div class="test-mode-container">
            <div class="test-mode-label">Test Mode:</div>
            <select id="test-mode" onchange="changeTestMode()">
                <option value="immediate">Learn Mode (Instant Feedback)</option>
                <option value="delayed">Exam Mode (Answer All First)</option>
            </select>
            <button onclick="showResults()" id="show-results-btn">üìä Show Results</button>
        </div>
        
        <!-- Score Header - STICKY -->
        <div class="score-header">
            <div class="score-info">
                <div class="score-display">
                    Score: <span id="current-score">0</span> / <span id="total-questions">0</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="score-progress"></div>
                    </div>
                    <div id="score-message" class="score-message">Start answering questions!</div>
                </div>
            </div>
        </div>
        
        <!-- Questions Container -->
        <div class="question-container" id="question-container">
            <!-- Questions loaded here -->
        </div>
        
        <!-- Analysis Panel (Hidden by default) -->
        <div class="analysis-panel" id="analysis-panel">
            <div class="analysis-header">
                <h2 class="analysis-title">Test Analysis</h2>
                <div id="rating-badge" class="rating-badge"></div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-percentage">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-correct">0</div>
                    <div class="stat-label">Correct Answers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-wrong">0</div>
                    <div class="stat-label">Wrong Answers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-skipped">0</div>
                    <div class="stat-label">Skipped</div>
                </div>
            </div>
            
            <div class="weak-areas">
                <h3 style="margin-bottom: 15px;">üìä Topic Performance</h3>
                <div id="topic-performance">
                    <!-- Topic analysis will be added here -->
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-secondary" onclick="resetTest()">üîÑ Restart Test</button>
            <button class="btn btn-primary" onclick="showAnalysis()" id="analysis-btn" style="display: none;">
                üìà Show Analysis
            </button>
        </div>
    </div>
</div>

<script>
    // ====== GRAMMAR TEST LOGIC - FIXED VERSION ======
    
    // Sample grammar data (replace with your 230 questions)
    const grammarData = [
        {
            q: "Each team member ___ responsible for submitting report.",
            options: ["are", "is", "was", "be"],
            a: 1,
            explanation: "'Each' is always singular ‚Üí use 'is' (not 'are'). Example: Each student HAS a book.",
            topic: "Subject-Verb Agreement"
        },
        {
            q: "The minutes of the meeting ___ already been shared.",
            options: ["has", "have", "is", "was"],
            a: 1,
            explanation: "'Minutes' is plural ‚Üí use 'have' (not 'has'). Collective nouns like 'minutes' take plural verbs.",
            topic: "Subject-Verb Agreement"
        },
        {
            q: "I ___ the files yesterday.",
            options: ["prepare", "prepared", "have prepared", "am preparing"],
            a: 1,
            explanation: "'Yesterday' indicates completed past ‚Üí use simple past 'prepared'. Present perfect would need 'already' or 'yet'.",
            topic: "Tenses"
        },
        {
            q: "She ___ here for 5 years before promotion.",
            options: ["works", "worked", "has worked", "had worked"],
            a: 3,
            explanation: "Action completed before another past action ‚Üí use past perfect 'had worked'. Timeline: worked ‚Üí promotion (past).",
            topic: "Tenses"
        },
        {
            q: "He usually ___ emails in the morning.",
            options: ["is checking", "checks", "check", "has checked"],
            a: 1,
            explanation: "'Usually' indicates habit ‚Üí use simple present 'checks'. Present continuous is for actions happening now.",
            topic: "Tenses"
        },
        // Add your remaining 225 questions here...
    ];
    
    // ====== STATE VARIABLES ======
    let currentScore = 0;
    let answeredCount = 0;
    let testMode = 'immediate';
    let userAnswers = [];
    let isTestComplete = false;
    
    // ====== INITIALIZATION ======
    document.addEventListener('DOMContentLoaded', function() {
        loadGrammarTest();
        setupSpeaking();
    });
    
    // ====== TAB SWITCHING ======
    function showTab(tabId) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
        
        if (tabId === 'grammar') {
            updateScoreDisplay();
        }
    }
    
    // ====== GRAMMAR TEST FUNCTIONS ======
    
    function loadGrammarTest() {
        const container = document.getElementById('question-container');
        container.innerHTML = '';
        
        userAnswers = new Array(grammarData.length).fill(null);
        currentScore = 0;
        answeredCount = 0;
        isTestComplete = false;
        
        grammarData.forEach((item, idx) => {
            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = `question-${idx}`;
            card.innerHTML = `
                <div>
                    <span class="question-number">${idx + 1}</span>
                    <strong>Topic: ${item.topic || 'Grammar'}</strong>
                </div>
                <div class="question-text">${item.q}</div>
                <div class="options-grid" id="options-${idx}">
                    ${item.options.map((opt, oIdx) => `
                        <button class="option-btn" onclick="selectAnswer(${idx}, ${oIdx})">${opt}</button>
                    `).join('')}
                </div>
                <div class="explanation-box" id="explanation-${idx}"></div>
            `;
            container.appendChild(card);
        });
        
        document.getElementById('total-questions').textContent = grammarData.length;
        updateScoreDisplay();
        document.getElementById('analysis-btn').style.display = 'none';
        document.getElementById('analysis-panel').classList.remove('show');
    }
    
    // FIXED: Single answer selection function
    function selectAnswer(qIdx, oIdx) {
        if (isTestComplete && testMode === 'delayed') return;
        
        const questionCard = document.getElementById(`question-${qIdx}`);
        const optionBtns = document.querySelectorAll(`#options-${qIdx} .option-btn`);
        const explanationBox = document.getElementById(`explanation-${qIdx}`);
        
        // Prevent multiple selections in immediate mode
        if (testMode === 'immediate' && userAnswers[qIdx] !== null) return;
        
        // Store answer
        userAnswers[qIdx] = oIdx;
        questionCard.classList.add('answered');
        
        if (testMode === 'immediate') {
            // IMMEDIATE FEEDBACK MODE
            optionBtns.forEach(btn => btn.disabled = true);
            
            // Check if correct
            const isCorrect = (oIdx === grammarData[qIdx].a);
            
            // Mark correct/incorrect
            optionBtns.forEach((btn, idx) => {
                if (idx === grammarData[qIdx].a) {
                    btn.classList.add('correct');
                } else if (idx === oIdx && !isCorrect) {
                    btn.classList.add('wrong');
                }
            });
            
            // Update score
            if (isCorrect) {
                currentScore++;
                explanationBox.innerHTML = `
                    <div class="explanation-title">
                        <span style="color:var(--success)">‚úÖ CORRECT!</span>
                    </div>
                    <p>${grammarData[qIdx].explanation}</p>
                `;
            } else {
                explanationBox.innerHTML = `
                    <div class="explanation-title">
                        <span style="color:var(--danger)">‚ùå INCORRECT</span>
                    </div>
                    <p>${grammarData[qIdx].explanation}</p>
                `;
            }
            
            explanationBox.classList.add('show');
            answeredCount++;
            
        } else {
            // EXAM MODE (Delayed feedback)
            // Remove selection from all buttons in this question
            optionBtns.forEach(btn => {
                btn.classList.remove('selected');
                btn.disabled = false; // Allow changing in exam mode
            });
            
            // Mark selected button
            optionBtns[oIdx].classList.add('selected');
            
            // Count as answered if first time
            if (userAnswers[qIdx] !== null && userAnswers[qIdx] !== undefined) {
                // Already counted
            } else {
                answeredCount++;
            }
            
            // Hide explanation in exam mode
            explanationBox.classList.remove('show');
        }
        
        updateScoreDisplay();
    }
    
    function updateScoreDisplay() {
        const total = grammarData.length;
        const progress = total > 0 ? (answeredCount / total) * 100 : 0;
        
        document.getElementById('current-score').textContent = currentScore;
        document.getElementById('score-progress').style.width = `${progress}%`;
        
        const messageEl = document.getElementById('score-message');
        if (answeredCount === 0) {
            messageEl.textContent = "Start answering questions!";
        } else if (answeredCount === total) {
            messageEl.textContent = `Test complete! Score: ${currentScore}/${total}`;
            isTestComplete = true;
            document.getElementById('analysis-btn').style.display = 'block';
        } else {
            if (testMode === 'delayed') {
                messageEl.textContent = `${answeredCount}/${total} answered (Exam Mode - Click 'Show Results')`;
            } else {
                messageEl.textContent = `${answeredCount}/${total} answered`;
            }
        }
    }
    
    function changeTestMode() {
        testMode = document.getElementById('test-mode').value;
        const resultsBtn = document.getElementById('show-results-btn');
        
        if (testMode === 'delayed') {
            resultsBtn.style.display = 'block';
            alert("üìù Exam Mode: Answer all questions first, then click 'Show Results' to see your score and explanations.");
            resetTest();
        } else {
            resultsBtn.style.display = 'none';
            resetTest();
        }
    }
    
    function showResults() {
        if (testMode !== 'delayed') return;
        
        // Calculate final score
        currentScore = 0;
        grammarData.forEach((item, idx) => {
            if (userAnswers[idx] === item.a) {
                currentScore++;
            }
            
            const optionBtns = document.querySelectorAll(`#options-${idx} .option-btn`);
            const explanationBox = document.getElementById(`explanation-${idx}`);
            
            // Mark correct/incorrect
            optionBtns.forEach((btn, btnIdx) => {
                btn.disabled = true;
                if (btnIdx === item.a) {
                    btn.classList.add('correct');
                } else if (btnIdx === userAnswers[idx] && btnIdx !== item.a) {
                    btn.classList.add('wrong');
                }
            });
            
            // Show explanation
            if (userAnswers[idx] === item.a) {
                explanationBox.innerHTML = `
                    <div class="explanation-title">
                        <span style="color:var(--success)">‚úÖ CORRECT!</span>
                    </div>
                    <p>${item.explanation}</p>
                `;
            } else if (userAnswers[idx] === null) {
                explanationBox.innerHTML = `
                    <div class="explanation-title">
                        <span style="color:var(--warning)">‚è∏Ô∏è NOT ATTEMPTED</span>
                    </div>
                    <p>${item.explanation}</p>
                `;
            } else {
                explanationBox.innerHTML = `
                    <div class="explanation-title">
                        <span style="color:var(--danger)">‚ùå INCORRECT</span>
                    </div>
                    <p>${item.explanation}</p>
                `;
            }
            explanationBox.classList.add('show');
        });
        
        answeredCount = grammarData.length;
        isTestComplete = true;
        updateScoreDisplay();
        showAnalysis();
    }
    
    function resetTest() {
        loadGrammarTest();
        document.getElementById('test-mode').value = 'immediate';
        document.getElementById('show-results-btn').style.display = 'none';
        testMode = 'immediate';
    }
    
    // ====== ANALYSIS FUNCTIONS ======
    
    function showAnalysis() {
        if (!isTestComplete && testMode === 'delayed') {
            alert("Please complete all questions first!");
            return;
        }
        
        const total = grammarData.length;
        const correct = currentScore;
        const wrong = grammarData.reduce((count, item, idx) => {
            return count + (userAnswers[idx] !== null && userAnswers[idx] !== item.a ? 1 : 0);
        }, 0);
        const skipped = grammarData.reduce((count, item, idx) => {
            return count + (userAnswers[idx] === null ? 1 : 0);
        }, 0);
        const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
        
        // Update stats
        document.getElementById('stat-percentage').textContent = `${percentage}%`;
        document.getElementById('stat-correct').textContent = correct;
        document.getElementById('stat-wrong').textContent = wrong;
        document.getElementById('stat-skipped').textContent = skipped;
        
        // Set rating
        const ratingBadge = document.getElementById('rating-badge');
        ratingBadge.className = 'rating-badge ';
        
        if (percentage >= 90) {
            ratingBadge.textContent = 'üéØ EXCELLENT';
            ratingBadge.classList.add('rating-excellent');
        } else if (percentage >= 70) {
            ratingBadge.textContent = 'üëç GOOD';
            ratingBadge.classList.add('rating-good');
        } else if (percentage >= 50) {
            ratingBadge.textContent = 'üìä AVERAGE';
            ratingBadge.classList.add('rating-average');
        } else {
            ratingBadge.textContent = 'üìö NEEDS IMPROVEMENT';
            ratingBadge.classList.add('rating-needs-improvement');
        }
        
        // Analyze weak areas
        const topicPerformance = document.getElementById('topic-performance');
        topicPerformance.innerHTML = '';
        
        // Group by topic
        const topicStats = {};
        grammarData.forEach((item, idx) => {
            const topic = item.topic || 'General';
            if (!topicStats[topic]) {
                topicStats[topic] = { total: 0, correct: 0 };
            }
            topicStats[topic].total++;
            if (userAnswers[idx] === item.a) {
                topicStats[topic].correct++;
            }
        });
        
        // Display topic performance
        for (const [topic, stats] of Object.entries(topicStats)) {
            const topicPercentage = Math.round((stats.correct / stats.total) * 100);
            const barWidth = Math.max(10, topicPercentage);
            
            topicPerformance.innerHTML += `
                <div class="weak-area-item">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>${topic}</strong>
                        <span>${stats.correct}/${stats.total} (${topicPercentage}%)</span>
                    </div>
                    <div style="height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                        <div style="width: ${barWidth}%; height: 100%; 
                             background: ${topicPercentage >= 80 ? '#10b981' : topicPercentage >= 60 ? '#f59e0b' : '#ef4444'};">
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Show analysis panel
        document.getElementById('analysis-panel').classList.add('show');
        document.getElementById('analysis-btn').style.display = 'none';
        
        // Scroll to analysis
        document.getElementById('analysis-panel').scrollIntoView({ behavior: 'smooth' });
    }
    
    // ====== SPEAKING FUNCTIONS ======
    
    function setupSpeaking() {
        // Basic speaking functionality
        const speakData = [
            { q: "Tell me about yourself.", h: "Mention your background, interests, and goals." },
            { q: "What are your strengths?", h: "Talk about your skills and qualities." },
            { q: "Where were you born?", h: "Describe your hometown or country." },
            { q: "Why do you want to learn English?", h: "Share your motivations and goals." },
            { q: "Describe your ideal day.", h: "Talk about what you would do from morning to night." }
        ];
        
        window.speakQuestions = speakData;
        window.currentSpeakIndex = 0;
        
        document.getElementById('speak-q-text').textContent = speakData[0].q;
        document.getElementById('speak-q-hint').textContent = "Tip: " + speakData[0].h;
    }
    
    function toggleMic() {
        const micBtn = document.getElementById('mic-btn');
        const status = document.getElementById('mic-status');
        
        if (micBtn.textContent.includes("Start")) {
            micBtn.innerHTML = "üõë Stop Recording";
            micBtn.style.background = "#ef4444";
            status.textContent = "Status: Recording... Speak now!";
            simulateSpeechRecognition();
        } else {
            micBtn.innerHTML = "üé§ Start Speaking";
            micBtn.style.background = "var(--primary)";
            status.textContent = "Status: Ready";
        }
    }
    
    function simulateSpeechRecognition() {
        // Simulate speech recognition with sample responses
        setTimeout(() => {
            const sampleResponses = [
                "I am a student learning English. I want to improve my speaking skills for my future career.",
                "My strengths include being hardworking, dedicated, and eager to learn new things.",
                "I was born in Manila, which is the capital city of the Philippines.",
                "I want to learn English because it is important for international communication and career opportunities.",
                "My ideal day starts with exercise, followed by studying, spending time with family, and reading before bed."
            ];
            
            const randomResponse = sampleResponses[Math.floor(Math.random() * sampleResponses.length)];
            document.getElementById('transcript-display').textContent = randomResponse;
            
            // Provide feedback
            const feedback = `
                <div style="color: var(--success); margin-bottom: 10px;">
                    ‚úÖ Good pronunciation and grammar structure!
                </div>
                <div style="color: var(--primary);">
                    üí° <strong>Tip:</strong> Try to use more descriptive adjectives and vary your sentence structures.
                </div>
                <div style="margin-top: 10px; color: #64748b;">
                    <small>Practice speaking for 2-3 minutes on each topic to build fluency.</small>
                </div>
            `;
            document.getElementById('ai-feedback').innerHTML = feedback;
            
            // Reset mic button
            document.getElementById('mic-btn').innerHTML = "üé§ Start Speaking";
            document.getElementById('mic-btn').style.background = "var(--primary)";
            document.getElementById('mic-status').textContent = "Status: Analysis complete";
            
        }, 2000);
    }
</script>
</body>
</html>
